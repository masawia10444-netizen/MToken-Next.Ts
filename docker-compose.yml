version: '3.8'

services:
  app:
    container_name: mtoken_n-app
    build: .
    restart: always
    ports:
      - "1040:3000"
    env_file:
      - .env
    # ✅ จุดสำคัญ 1: บอกให้รอ DB เกิดก่อน
    depends_on:
      - db
    # ✅ จุดสำคัญ 2: ยัดเข้า Network เดียวกัน
    networks:
      - my-network

  db:
    image: postgres:15-alpine
    # ✅ จุดสำคัญ 3: ชื่อนี้ต้องตรงกับ DB_HOST ใน .env เป๊ะๆ
    container_name: mtoken-db-v2
    restart: always
    env_file:
      - .env
    volumes:
      - pgdata-v2:/var/lib/postgresql/data
    ports:
      - "5444:5432"
    networks:
      - my-network

volumes:
  pgdata-v2:

# ✅ จุดสำคัญ 4: สร้าง Network กลางให้มันคุยกัน
networks:
  my-network:
    driver: bridge